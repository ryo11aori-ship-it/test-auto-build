name: Test AutoBuildTool (Windows)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - 'sample/**'
      - 'tool/**'
      - '.github/workflows/test-autobuild.yml'

jobs:
  build-and-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List repo root (debug)
        run: dir

      # --- 追加: Install Zig via Chocolatey, export AUTOBUILD_ZIG and copy to tool\zig ---
      - name: Install Zig and expose path
        shell: powershell
        run: |
          choco install zig -y
          $zig = (Get-Command zig -ErrorAction Stop).Source
          Write-Host "Found zig at: $zig"
          # Export env var for later steps
          echo "AUTOBUILD_ZIG=$zig" >> $env:GITHUB_ENV
          # Also copy into repo workspace under tool\zig\zig.exe to match local lookup
          $dest = Join-Path $PWD "tool\zig"
          New-Item -Path $dest -ItemType Directory -Force | Out-Null
          Copy-Item -Path $zig -Destination (Join-Path $dest "zig.exe") -Force
          Write-Host "Copied zig to: $dest"

      - name: Ensure autobuildtool.exe exists
        shell: cmd
        run: |
          if not exist autobuildtool.exe (
            echo "ERROR: autobuildtool.exe not found at repo root"
            exit 1
          )
          echo "autobuildtool.exe found"

      - name: Set code page to UTF-8 (optional but recommended)
        shell: cmd
        run: chcp 65001

      - name: Build sample/main.py with autobuildtool (non-interactive)
        shell: cmd
        run: |
          REM Pipe desired output name into the tool
          echo sample_app.exe | .\autobuildtool.exe sample\main.py

      - name: Verify built exe exists
        shell: cmd
        run: |
          if exist sample_app.exe (
            echo "Built sample_app.exe found"
            dir sample_app.exe
          ) else (
            echo "Build failed: sample_app.exe not found" & exit /b 2
          )

      - name: Run the built sample and capture stdout
        shell: cmd
        run: |
          echo Running sample_app.exe...
          sample_app.exe > run_output.txt 2>&1
          type run_output.txt

      - name: Upload artifacts (exe, log, ppm)
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            sample_app.exe
            run_output.txt
            mandelbrot_test.ppm