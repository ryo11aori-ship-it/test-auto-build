name: Test AutoBuildTool (Windows)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - 'sample/**'
      - 'tool/**'
      - '.github/workflows/test-autobuild.yml'

jobs:
  build-and-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List repo root (debug)
        shell: cmd
        run: dir

      # --- Install Zig and expose path (for C builds) ---
      - name: Install Zig and expose path
        shell: powershell
        run: |
          choco install zig -y
          $zig = (Get-Command zig -ErrorAction Stop).Source
          Write-Host "Found zig at: $zig"
          echo "AUTOBUILD_ZIG=$zig" >> $env:GITHUB_ENV
          $dest = Join-Path $PWD "tool\zig"
          New-Item -Path $dest -ItemType Directory -Force | Out-Null
          Copy-Item -Path $zig -Destination (Join-Path $dest "zig.exe") -Force
          Write-Host "Copied zig to: $dest"

      # --- Install PyInstaller (required for .py -> exe) ---
      - name: Install PyInstaller
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Ensure autobuildtool.exe exists (optional)
        shell: cmd
        run: |
          if not exist autobuildtool.exe (
            echo WARNING: autobuildtool.exe not found at repo root
          ) else (
            echo autobuildtool.exe found
          )

      - name: Set code page to UTF-8
        shell: cmd
        run: chcp 65001

      ################################################################
      # Python build (CI-optimized): use pyinstaller --onedir directly
      ################################################################
      - name: Build sample/main.py with PyInstaller (onedir, CI)
        shell: cmd
        run: |
          pyinstaller --onedir --clean --name sample_app sample\main.py

      - name: Debug dist folder (if present)
        shell: cmd
        run: |
          if exist dist (
            echo ---- dist folder contents ----
            dir dist
            if exist dist\sample_app (
              echo ---- dist\sample_app contents ----
              dir dist\sample_app
            )
          ) else (
            echo dist folder not present
          )

      - name: Verify built exe exists (onsite in dist or root)
        shell: cmd
        run: |
          if exist dist\sample_app\sample_app.exe (
            echo Found dist\sample_app\sample_app.exe
          ) else if exist dist\sample_app.exe (
            echo Found dist\sample_app.exe
          ) else if exist sample_app.exe (
            echo Found sample_app.exe in repo root
          ) else (
            echo Build failed: no exe found & exit /b 2
          )

      - name: Run the built sample and capture stdout (with timeout guard)
        shell: powershell
        run: |
          Write-Host "Preparing to run sample_app.exe..."

          # Determine run directory and exe path
          if (Test-Path (Join-Path $PWD "dist\sample_app\sample_app.exe")) {
            $runDir = Join-Path $PWD "dist\sample_app"
            $exePath = Join-Path $runDir "sample_app.exe"
            Write-Host "Will run from dist\sample_app"
          } elseif (Test-Path (Join-Path $PWD "dist\sample_app.exe")) {
            # rare case: dist\sample_app.exe
            $runDir = Join-Path $PWD "dist"
            $exePath = Join-Path $runDir "sample_app.exe"
            Write-Host "Will run from dist"
          } elseif (Test-Path (Join-Path $PWD "sample_app.exe")) {
            $runDir = $PWD
            $exePath = Join-Path $runDir "sample_app.exe"
            Write-Host "Will run from repo root"
          } else {
            throw "No executable found to run"
          }

          Write-Host "Executable path: $exePath"
          $stdout = Join-Path $PWD "run_output.txt"
          $stderr = Join-Path $PWD "run_error.txt"

          # Start process within the folder where supporting files / DLLs live
          $ps = Start-Process -FilePath $exePath `
                               -WorkingDirectory $runDir `
                               -RedirectStandardOutput $stdout `
                               -RedirectStandardError $stderr `
                               -PassThru

          # Wait up to 120 seconds for the process to finish
          $finished = $ps.WaitForExit(120000)
          if (-not $finished) {
            Write-Host "Process did not exit within 120s; killing..."
            try { $ps.Kill() } catch { Write-Host "Failed to kill process: $_" }
            throw "Process timeout"
          }

          # Show outputs if present
          if (Test-Path $stdout) {
            Write-Host "---- STDOUT ----"
            Get-Content $stdout -Raw
          } else {
            Write-Host "No stdout file produced."
          }

          if (Test-Path $stderr) {
            Write-Host "---- STDERR ----"
            Get-Content $stderr -Raw
          }

          # Fail the step if process exited with non-zero
          if ($ps.ExitCode -ne 0) {
            throw "Process exited with code $($ps.ExitCode)"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          if-no-files-found: warn
          path: |
            sample_app.exe
            dist\sample_app\**
            dist\sample_app.exe
            run_output.txt
            run_error.txt
            mandelbrot_test.ppm